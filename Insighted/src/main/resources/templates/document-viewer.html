<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document Viewer - InsightEd Platform</title>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
<!-- Navigation -->
<nav class="navbar">
  <div class="container">
    <a href="index.html" class="nav-brand">
      <img th:src="@{/images/insighted_logo.png}" style="width: 120px; height: 55px">
    </a>
    <div class="nav-links">
      <button class="btn btn-ghost" onclick="history.back()">‚Üê Back</button>
      <span class="badge badge-submitted">John Lewis - Essay on Machine Learning</span>
    </div>
  </div>
</nav>

<!-- Document Viewer Layout -->
<div class="document-viewer" style="padding: 2rem;">
  <!-- Document Panel -->
  <div class="document-panel">
    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
      <h3>Document Preview</h3>
      <div class="flex gap-2">
        <button class="btn btn-ghost" id="zoomOut">üîç-</button>
        <button class="btn btn-ghost" id="zoomIn">üîç+</button>
      </div>
    </div>

    <div id="documentContent">
      <p id="para1" class="clickable-text">Paragraph 1 text‚Ä¶</p>
      <p id="para2" class="clickable-text">Paragraph 2 text‚Ä¶</p>
      <p id="para3" class="clickable-text">Paragraph 3 text‚Ä¶</p>
    </div>

    <!-- Feedback Panel -->
    <div class="feedback-panel">
      <h3>Feedback & Comments</h3>
      <div id="commentForm" class="hidden">
        <h4>Add Comment</h4>
        <p id="selectedText"></p>
        <textarea id="commentText" rows="3" placeholder="Enter feedback..."></textarea>
        <button id="saveComment">Save</button>
        <button id="cancelComment">Cancel</button>
      </div>

      <div id="commentsList"></div>
    </div>

    <!-- Grade Section (for teachers) -->
    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius);">
      <h4 style="margin-bottom: 0.5rem;">Grade Assignment</h4>
      <div class="flex gap-2 items-center">
        <input type="number" id="gradeInput" class="form-input" style="width: 80px;" placeholder="Grade" min="0" max="100">
        <span style="color: var(--gray-600);">/ 100</span>
        <button class="btn btn-primary" id="saveGrade">Save Grade</button>
      </div>
    </div>
  </div>
</div>

<script th:src="@{/scripts/script.js}"></script>
<script>
  let selectedPara = null;
  let assignmentId = /*[[${assignment.id}]]*/ 1; // Thymeleaf injects ID

  document.querySelectorAll(".clickable-text").forEach(p => {
    p.addEventListener("click", () => {
      selectedPara = p.id;
      document.getElementById("selectedText").textContent = "Commenting on " + p.textContent;
      document.getElementById("commentForm").classList.remove("hidden");
    });
  });

  document.getElementById("saveComment").addEventListener("click", () => {
    let comment = document.getElementById("commentText").value;

    fetch("/feedback/add", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        assignmentId: assignmentId,
        paragraphId: selectedPara,
        comment: comment
      })
    })
            .then(res => res.text())
            .then(msg => {
              alert(msg);
              // Show comment in UI
              let div = document.createElement("div");
              div.innerHTML = `<b>You:</b> ${comment} <span style="font-size:0.8em;color:gray">(on ${selectedPara})</span>`;
              document.getElementById("commentsList").appendChild(div);
              document.getElementById("commentText").value = "";
              document.getElementById("commentForm").classList.add("hidden");
            });
  });

  document.getElementById("cancelComment").addEventListener("click", () => {
    document.getElementById("commentForm").classList.add("hidden");
  });

  fetch(`/feedback/byAssignment/${assignmentId}`)
          .then(res => res.json())
          .then(feedbacks => {
            let list = document.getElementById("commentsList");
            list.innerHTML = "";
            feedbacks.forEach(fb => {
              let div = document.createElement("div");
              div.innerHTML = `<b>${fb.teacherName}:</b> ${fb.comment} <span style="font-size:0.8em;color:gray">(on ${fb.paragraphId})</span>`;
              list.appendChild(div);

              // Optional: highlight paragraph
              document.getElementById(fb.paragraphId).style.background = "#e0f7fa";
            });
          });
</script>
</body>

</html>