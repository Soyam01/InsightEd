<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document Viewer - InsightEd Platform</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <style>
    .document-viewer {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      min-height: calc(100vh - 120px);
    }
    .document-panel, .feedback-panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
    }
    .feedback-panel { display:flex; flex-direction:column; max-height:calc(100vh - 140px); overflow-y:auto; }
    .document-content { background:#fefefe; border:1px solid #e5e7eb; border-radius:8px; overflow-y:auto; max-height:calc(100vh - 250px);}
    .document-section {
      padding:1rem 2rem; margin:1rem 0; line-height:1.8; cursor:pointer;
      border-radius:4px; border-left:3px solid transparent; transition:all 0.2s ease; position:relative;
      user-select:text;
    }
    .document-section:hover { background:#f0f9ff; border-left-color:#dbeafe; }
    .document-section.selected { background:#dbeafe; border-left-color:#3b82f6; user-select:none; }
    .document-section.has-feedback { border-left-color:#10b981; background:rgba(16,185,129,0.05); }
    .document-section.has-feedback::after { content:"üí¨"; position:absolute; right:1rem; top:0.5rem; font-size:0.875rem; }
    .comment-form { margin-bottom:1.5rem; padding:1rem; background:#f0f9ff; border-radius:8px; border:2px solid #dbeafe;}
    .comment-item { padding:1rem; border-bottom:1px solid #e5e7eb; transition:all 0.2s ease; cursor:pointer; }
    .comment-item:hover { background:#f9fafb; }
    .comment-author { font-weight:600; color:#1f2937; margin-bottom:0.25rem;}
    .comment-text { color:#4b5563; margin-bottom:0.5rem;}
    .comment-time { font-size:0.75rem; color:#6b7280;}
    .section-badge { font-size:0.75rem; color:#3b82f6; background:#dbeafe; padding:0.125rem 0.5rem; border-radius:12px; display:inline-block; margin-top:0.5rem;}
    .grade-section { margin-top:1.5rem; padding:1rem; background:#f9fafb; border-radius:8px; }
    .hidden { display:none; }
    .alert { padding:1rem; border-radius:8px; margin-bottom:1rem;}
    .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
    .alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
  </style>
</head>

<body>
<!-- Navigation -->
<nav class="navbar">
  <div class="container">
    <a th:href="@{/dashboard}" class="nav-brand">üìö InsightEd</a>
    <div class="nav-links">
      <button class="btn btn-ghost" onclick="history.back()">‚Üê Back</button>
      <span class="badge badge-submitted"
            th:text="${assignment.student.firstName + ' ' + assignment.student.lastName + ' - ' + assignment.title}">
        Student Name - Assignment Title
      </span>
    </div>
  </div>
</nav>

<!-- Hidden fields for JS (safe to serialize) -->
<input type="hidden" id="assignmentId" th:value="${assignment.id}">
<input type="hidden" id="isTeacher" th:value="${isTeacher}">
<input type="hidden" id="currentUserFirstName" th:value="${currentUser?.firstName}">
<input type="hidden" id="currentUserLastName" th:value="${currentUser?.lastName}">

<!-- Document Viewer Layout -->
<div class="document-viewer" style="padding: 2rem;">
  <!-- Document Panel -->
  <div class="document-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
      <h3>Document Preview</h3>
    </div>

    <!-- Assignment Info -->
    <div style="background:#f9fafb; padding:1rem; border-radius:8px; margin-bottom:1rem; border-left:4px solid #3b82f6;">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; font-size:0.875rem;">
        <div><strong>Student:</strong>
          <span th:text="${assignment.student.firstName + ' ' + assignment.student.lastName}"></span>
        </div>
        <div><strong>Subject:</strong> <span th:text="${assignment.subject}"></span></div>
        <div><strong>Submitted:</strong>
          <span th:text="${#temporals.format(assignment.submittedAt, 'MMM dd, yyyy HH:mm')}"></span>
        </div>
<!--        <div><strong>Status:</strong>-->
<!--          <span class="badge"-->
<!--                th:classappend="${assignment.status == T(com.app.Insighted.model.AssignmentStatus).REVIEWED} ? 'badge-reviewed' : 'badge-pending'"-->
<!--                th:text="${assignment.status}"></span>-->
<!--        </div>-->
        <div th:if="${assignment.grade != null}" style="grid-column:1 / -1;">
          <strong>Grade:</strong>
          <span style="font-size:1.25rem; font-weight:bold; color:#10b981;"
                th:text="${assignment.grade + '%'}"></span>
        </div>
      </div>
    </div>

    <div class="document-content" id="documentContent">
      <div class="document-title" style="padding:2rem 2rem 1rem; border-bottom:1px solid #e5e7eb;">
        <h2 th:text="${assignment.title}">Assignment Title</h2>
        <p th:if="${assignment.description}" style="color:#6b7280; font-style:italic; margin-top:0.5rem;"
           th:text="${assignment.description}"></p>
      </div>

      <div id="documentSections">
        <div th:each="section, iterStat : ${assignment.sections}"
             class="document-section"
             th:id="'section-' + ${section.id}"
             th:classappend="${not #lists.isEmpty(section.feedbacks)} ? 'has-feedback' : ''"
             th:attr="data-section-id=${section.id}">
          <p th:text="${section.content}">Section content here</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Panel -->
  <div class="feedback-panel">
    <h3 style="margin-bottom:1rem;">Feedback & Comments</h3>

    <!-- Add Comment Form (Teachers Only) -->
    <div th:if="${isTeacher}" id="commentForm" class="comment-form hidden">
      <h4 style="margin-bottom:0.5rem; color:#3b82f6;">Add Comment</h4>
      <p style="font-size:0.875rem; color:#6b7280; margin-bottom:1rem;" id="selectedText"></p>

      <form id="feedbackForm">
        <textarea id="commentText" class="form-input" rows="3"
                  placeholder="Enter your feedback..." required></textarea>

        <div style="margin-top:0.5rem;">
          <label for="feedbackType" style="font-size:0.875rem; color:#6b7280;">Feedback Type:</label>
          <select id="feedbackType" class="form-select" style="width:auto; display:inline-block; margin-left:0.5rem;">
            <option value="GENERAL">General</option>
            <option value="POSITIVE">Positive</option>
            <option value="SUGGESTION">Suggestion</option>
            <option value="QUESTION">Question</option>
            <option value="CORRECTION">Correction</option>
          </select>
        </div>

        <div style="margin-top:1rem;">
          <button type="submit" class="btn btn-primary" id="saveComment">Save Comment</button>
          <button type="button" class="btn btn-ghost" id="cancelComment">Cancel</button>
        </div>
        <input type="hidden" id="selectedSectionId">
      </form>
    </div>

    <!-- Existing Comments -->
    <div id="commentsList" style="flex:1; overflow-y:auto;">
      <div th:each="feedback : ${assignment.sections}" th:remove="tag">
        <div th:each="comment : ${feedback.feedbacks}"
             class="comment-item"
             th:attr="data-section-id=${feedback.id}">
          <div class="comment-author"
               th:text="${comment.teacher.firstName + ' ' + comment.teacher.lastName}">Teacher Name</div>
          <div class="comment-text" th:text="${comment.comment}">Comment text</div>
          <div class="comment-time"
               th:text="${#temporals.format(comment.createdAt, 'MMM dd, yyyy HH:mm')}">Time</div>
          <div style="margin-top:0.5rem;">
            <span class="section-badge" th:text="'Paragraph ' + ${feedback.sectionNumber}">Paragraph X</span>
          </div>
        </div>
      </div>

      <div th:if="${#lists.isEmpty(assignment.sections) or #lists.isEmpty(assignment.sections[0].feedbacks)}"
           style="text-align:center; color:#6b7280; padding:2rem;">
        <p>No feedback yet.</p>
        <p th:if="${isTeacher}" style="font-size:0.875rem;">Click on any paragraph to add your first comment.</p>
      </div>
    </div>

    <!-- Grade Section -->
    <div th:if="${isTeacher}" class="grade-section" id="gradeSection">
      <h4 style="margin-bottom:0.5rem;">Grade Assignment</h4>
      <form id="gradeForm">
        <div style="margin-bottom:1rem;">
          <input type="number" id="gradeInput" class="form-input"
                 style="width:80px;" placeholder="Grade" min="0" max="100" step="0.1"
                 th:value="${assignment.grade}">
          <span style="color:#6b7280;">/ 100</span>
          <button type="submit" class="btn btn-primary" id="saveGrade">Save Grade</button>
        </div>
        <textarea id="overallComments" class="form-input" rows="3"
                  placeholder="Overall comments about the assignment..."
                  style="margin-top:0.5rem;"></textarea>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const assignmentId = document.getElementById("assignmentId").value;
    const isTeacher = document.getElementById("isTeacher").value === 'true';
    const currentUser = {
      firstName: document.getElementById("currentUserFirstName").value,
      lastName: document.getElementById("currentUserLastName").value
    };

    let selectedSection = null;

    initializeDocumentSections();
    initializeFeedbackForm();
    initializeGradeForm();

    function initializeDocumentSections() {
      const sections = document.querySelectorAll('.document-section');
      sections.forEach(section => {
        section.addEventListener('click', function() {
          if (!isTeacher) return;
          const sectionId = this.getAttribute('data-section-id');
          selectSection(sectionId, this);
        });
      });
    }

    function selectSection(sectionId, sectionElement) {
      document.querySelectorAll('.document-section').forEach(s => s.classList.remove('selected'));
      sectionElement.classList.add('selected');
      selectedSection = sectionId;

      const commentForm = document.getElementById('commentForm');
      commentForm.classList.remove('hidden');

      const sectionNumber = Array.from(sectionElement.parentNode.children).indexOf(sectionElement) + 1;
      document.getElementById('selectedText').textContent = `Adding comment to paragraph ${sectionNumber}`;
      document.getElementById('selectedSectionId').value = sectionId;
      document.getElementById('commentText').focus();
    }

    function initializeFeedbackForm() {
      if (!isTeacher) return;
      const feedbackForm = document.getElementById('feedbackForm');
      const cancelBtn = document.getElementById('cancelComment');

      feedbackForm?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveFeedback();
      });

      cancelBtn?.addEventListener('click', function() {
        hideFeedbackForm();
      });
    }

    function initializeGradeForm() {
      if (!isTeacher) return;
      const gradeForm = document.getElementById('gradeForm');
      gradeForm?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveGrade();
      });
    }

    function saveFeedback() {
      const commentText = document.getElementById('commentText').value.trim();
      const sectionId = document.getElementById('selectedSectionId').value;
      const feedbackType = document.getElementById('feedbackType').value;

      if (!commentText) {
        showNotification('Please enter a comment', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveComment');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Saving...';
      saveBtn.disabled = true;

      const feedbackData = {
        sectionId: parseInt(sectionId),
        comment: commentText,
        feedbackType: feedbackType,
        highlightedText: null
      };

      const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') ||
              document.querySelector('input[name="_csrf"]')?.value || '';

      fetch('/teacher/feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRF-TOKEN': csrfToken
        },
        body: JSON.stringify(feedbackData)
      })
              .then(response => {
                if (response.ok) {
                  showNotification('Feedback saved successfully!', 'success');
                  addFeedbackToUI(feedbackData, currentUser);
                  hideFeedbackForm();
                  const section = document.getElementById(`section-${sectionId}`);
                  if (section) section.classList.add('has-feedback');
                } else {
                  return response.text().then(errorText => {
                    throw new Error(errorText || 'Error saving feedback');
                  });
                }
              })
              .catch(error => {
                showNotification('Error saving feedback: ' + error.message, 'error');
              })
              .finally(() => {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
              });
    }

    function saveGrade() {
      const grade = document.getElementById('gradeInput').value;
      const overallComments = document.getElementById('overallComments').value;

      if (!grade || grade < 0 || grade > 100) {
        showNotification('Please enter a valid grade (0-100)', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveGrade');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Saving...';
      saveBtn.disabled = true;

      const gradeData = {
        grade: parseFloat(grade),
        overallComments: overallComments
      };

      const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') ||
              document.querySelector('input[name="_csrf"]')?.value || '';

      fetch('/teacher/grade/' + assignmentId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRF-TOKEN': csrfToken
        },
        body: JSON.stringify(gradeData)
      })
              .then(response => {
                if (response.ok) {
                  showNotification('Grade saved successfully!', 'success');
                } else {
                  return response.text().then(errorText => {
                    throw new Error(errorText || 'Error saving grade');
                  });
                }
              })
              .catch(error => {
                showNotification('Error saving grade: ' + error.message, 'error');
              })
              .finally(() => {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
              });
    }

    function hideFeedbackForm() {
      const commentForm = document.getElementById('commentForm');
      if (commentForm) commentForm.classList.add('hidden');
      document.getElementById('commentText').value = '';
      document.getElementById('feedbackType').value = 'GENERAL';
      document.querySelectorAll('.document-section').forEach(s => s.classList.remove('selected'));
      selectedSection = null;
    }

    function addFeedbackToUI(feedbackData, teacher) {
      const commentsList = document.getElementById('commentsList');
      const commentDiv = document.createElement('div');
      commentDiv.className = 'comment-item';
      commentDiv.setAttribute('data-section-id', feedbackData.sectionId);

      const section = document.getElementById('section-' + feedbackData.sectionId);
      const sections = document.querySelectorAll('.document-section');
      let sectionNumber = 1;
      for (let i = 0; i < sections.length; i++) {
        if (sections[i].getAttribute('data-section-id') == feedbackData.sectionId) {
          sectionNumber = i + 1;
          break;
        }
      }

      commentDiv.innerHTML = `
        <div class="comment-author">${teacher.firstName || 'Teacher'} ${teacher.lastName || ''}</div>
        <div class="comment-text">${feedbackData.comment}</div>
        <div class="comment-time">Just now</div>
        <div style="margin-top:0.5rem;">
          <span class="section-badge">Paragraph ${sectionNumber}</span>
        </div>
      `;

      commentsList.insertBefore(commentDiv, commentsList.firstChild);
    }

    function showNotification(message, type) {
      const existing = document.querySelectorAll('.notification');
      existing.forEach(n => n.remove());
      const notification = document.createElement('div');
      notification.className = `notification alert alert-${type === 'success' ? 'success' : 'error'}`;
      notification.style.cssText = `
        position:fixed; top:20px; right:20px;
        z-index:1000; min-width:300px; max-width:500px;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 5000);
    }
  });
</script>
</body>
</html>
